package com.winthier.exploits.sql;

import com.avaje.ebean.validation.NotNull;
import com.winthier.exploits.PlayerAction;
import com.winthier.exploits.WorldCoordinate;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import javax.persistence.Entity;
import javax.persistence.FetchType;
import javax.persistence.Id;
import javax.persistence.ManyToOne;
import javax.persistence.OneToOne;
import javax.persistence.Table;
import javax.persistence.UniqueConstraint;
import javax.persistence.Version;
import lombok.Getter;
import lombok.NonNull;
import lombok.Setter;

@Entity
@Table(name="player_entities",
       uniqueConstraints=@UniqueConstraint(columnNames={"player_id", "action_id", "index"}))
@Getter
@Setter
public class PlayerEntityTable
{
    @Id private Integer id;
    @ManyToOne(optional=false) private PlayerTable player;
    @NotNull private Integer actionId;
    @NotNull private Integer index;
    @NotNull private String entityType;
    @NotNull private Date updated;
    @Version private Integer version;

    static PlayerEntityTable find(@NonNull PlayerTable player, @NonNull PlayerAction action, int index) {
        return DB.unique(DB.get().find(PlayerEntityTable.class).where().eq("player", player).eq("action_id", action.id).eq("index", index).findList());
    }

    static PlayerEntityTable find(@NonNull UUID playerId, @NonNull PlayerAction action, int index) {
        PlayerTable player = PlayerTable.find(playerId);
        if (player == null) return null;
        return find(player, action, index);
    }

    public static List<PlayerEntityTable> findAll(@NonNull UUID playerId, @NonNull PlayerAction action) {
        PlayerTable player = PlayerTable.find(playerId);
        if (player == null) return Collections.emptyList();
        return DB.get().find(PlayerEntityTable.class).where().eq("player", player).eq("action_id", action.id).findList();
    }

    static PlayerEntityTable findOrCreate(@NonNull PlayerTable player, @NonNull PlayerAction action, int index, String entityType) {
        PlayerEntityTable result = find(player, action, index);
        if (result == null) {
            result = new PlayerEntityTable();
            result.setPlayer(player);
            result.setActionId(action.id);
            result.setIndex(index);
            result.setEntity(entityType);
            result.save();
        } else {
            result.setEntity(entityType);
        }
        return result;
    }

    public static PlayerEntityTable findOrCreate(@NonNull UUID player, @NonNull PlayerAction action, int index, String entityType) {
        return findOrCreate(PlayerTable.findOrCreate(player), action, index, entityType);
    }

    public void setEntity(String entityType) {
        setEntityType(entityType);
        setUpdated(new Date());
    }

    void save() {
        DB.get().save(this);
    }
}
