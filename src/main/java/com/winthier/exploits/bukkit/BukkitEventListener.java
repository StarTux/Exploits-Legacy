package com.winthier.exploits.bukkit;

import lombok.RequiredArgsConstructor;
import org.bukkit.block.Block;
import org.bukkit.block.BlockFace;
import org.bukkit.block.BlockState;
import org.bukkit.entity.Entity;
import org.bukkit.entity.LivingEntity;
import org.bukkit.entity.Player;
import org.bukkit.entity.Projectile;
import org.bukkit.event.Event;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockBreakEvent;
import org.bukkit.event.block.BlockBurnEvent;
import org.bukkit.event.block.BlockFadeEvent;
import org.bukkit.event.block.BlockGrowEvent;
import org.bukkit.event.block.BlockPistonExtendEvent;
import org.bukkit.event.block.BlockPistonRetractEvent;
import org.bukkit.event.block.BlockPlaceEvent;
import org.bukkit.event.entity.EntityChangeBlockEvent;
import org.bukkit.event.entity.EntityDamageByEntityEvent;
import org.bukkit.event.entity.EntityDeathEvent;
import org.bukkit.event.entity.EntityExplodeEvent;
import org.bukkit.event.world.StructureGrowEvent;

@RequiredArgsConstructor
public class BukkitEventListener implements Listener {
    private final BukkitExploitsPlugin plugin;

    @EventHandler(ignoreCancelled = true, priority = EventPriority.MONITOR)
    public void onBlockPlace(BlockPlaceEvent event) {
        plugin.exploits.setPlayerPlaced(event.getBlock(), true);
        plugin.exploits.onBlockPlace(event.getPlayer(), event.getBlock());
    }

    @EventHandler(ignoreCancelled = true, priority = EventPriority.MONITOR)
    public void onBlockBreak(BlockBreakEvent event) {
        plugin.exploits.setPlayerPlaced(event.getBlock(), false);
        plugin.exploits.onBlockBreak(event.getPlayer(), event.getBlock());
    }

    // @EventHandler(ignoreCancelled = true, priority = EventPriority.MONITOR)
    // public void onBlockGrow(BlockGrowEvent event) {
    //     plugin.exploits.setPlayerPlaced(event.getBlock(), false);
    // }

    // @EventHandler(ignoreCancelled = true, priority = EventPriority.MONITOR)
    // public void onBlockFade(BlockFadeEvent event) {
    //     plugin.exploits.setPlayerPlaced(event.getBlock(), false);
    // }

    // @EventHandler(ignoreCancelled = true, priority = EventPriority.MONITOR)
    // public void onBlockBurn(BlockBurnEvent event) {
    //     plugin.exploits.setPlayerPlaced(event.getBlock(), false);
    // }
    
    @EventHandler(ignoreCancelled = true, priority = EventPriority.MONITOR)
    public void onStructureGrow(StructureGrowEvent event) {
        for (BlockState block : event.getBlocks()) {
            plugin.exploits.setPlayerPlaced(block.getBlock(), false);
        }
    }

    @EventHandler(ignoreCancelled = true, priority = EventPriority.MONITOR)
    public void onBlockPistonExtend(BlockPistonExtendEvent event) {
        BlockFace direction = event.getDirection();
        for (Block block : event.getBlocks()) {
            plugin.exploits.setPlayerPlaced(block.getRelative(direction), true);
        }
    }

    @EventHandler(ignoreCancelled = true, priority = EventPriority.MONITOR)
    public void onBlockPistonRetract(BlockPistonRetractEvent event) {
        BlockFace direction = event.getDirection();
        for (Block block : event.getBlocks()) {
            plugin.exploits.setPlayerPlaced(block.getRelative(direction), true);
        }
    }

    @EventHandler(ignoreCancelled = true, priority = EventPriority.MONITOR)
    public void onEntityExplode(EntityExplodeEvent event) {
        for (Block block : event.blockList()) {
            plugin.exploits.setPlayerPlaced(block, false);
        }
    }

    @EventHandler(ignoreCancelled = true, priority = EventPriority.MONITOR)
    public void onEntityChangeBlock(EntityChangeBlockEvent event) {
        plugin.exploits.setPlayerPlaced(event.getBlock(), false);
    }

    @EventHandler(ignoreCancelled = true, priority = EventPriority.MONITOR)
    public void onEntityDeath(EntityDeathEvent event) {
        LivingEntity entity = event.getEntity();
        plugin.exploits.getEntityDamage().onEntityDeath(entity.getUniqueId());
        if (entity instanceof Player) return;
        if (!(entity.getLastDamageCause() instanceof EntityDamageByEntityEvent)) return;
        EntityDamageByEntityEvent eevent = (EntityDamageByEntityEvent)entity.getLastDamageCause();
        Entity damager = eevent.getDamager();
        Player player = null;
        if (damager instanceof Player) {
            player = (Player)damager;
        } else if (damager instanceof Projectile) {
            Projectile projectile = (Projectile)damager;
            if (!(projectile.getShooter() instanceof Player)) return;
            player = (Player)projectile.getShooter();
        }
        plugin.exploits.onEntityKill(player, entity);
    }
}
